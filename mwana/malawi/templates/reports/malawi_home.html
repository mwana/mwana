{% extends "base.html" %}
{% load forms_tags %}
{% load labresults_tags %}

{% block title %}Dashboard - {{ block.super }} for Health{% endblock %}

{% block javascripts %}
{{ block.super }}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="{{ STATIC_URL }}locations/javascripts/mask.js" type="text/javascript"></script>
<script type="text/javascript" src="{{ STATIC_URL }}malawi/javascripts/moment.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}malawi/javascripts/daterangepicker.js"></script>

{% endblock %}

{% block stylesheets %}
{{ block.super }}
<link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}locations/stylesheets/locations.css" />
<link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}locations/stylesheets/label-overlay.css" />
<link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}labresults/stylesheets/labresults.css" />
<link rel="stylesheet" href="{{ STATIC_URL }}malawi/stylesheets/daterangepicker-bs2.css" type="text/css" media="screen" />
{% endblock %}

{% block content %}

<div class="span12">

<div class="page-header">
  <h1>Dashboard</h1>
</div>

<!-- <h3>Report Options</h3> -->
<form method="GET" id="dash_options" action="">
<div class="well flush row-fluid">
  <div class="span12">
    <!-- Legend ? -->
    <div class="row-fluid">
      <div class="span4">
	<!-- r1c1 -->
	<div class="row-fluid">
	  <div class="span12">
	    <br />
	    <!-- r2c1 -->
	  </div>
	</div>
      </div>
      <div class="span4">
	<!-- r1c2 -->
	<div class="row-fluid">
	  <div class="span12">
	    <br />
	    <!-- r2c2 -->
	  </div>
	</div>
      </div>
      <div class="span4">
	<!-- r1c3 -->
	<div id="reportrange" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc">
	  <i class="glyphicon glyphicon-calendar icon-calendar icon-large"></i>
	  <span></span> <b class="caret"></b>
	</div>
	<script type="text/javascript" src="{{ STATIC_URL }}malawi/javascripts/reportrange.js"></script>
	<div class="row-fluid">
	  <div class="span12">
	    <br />
	    <!-- r2c3 -->
	    <input type="hidden" name="startdate" value='{{startdate}}' id="startdate" />
	    <input type="hidden" name="enddate" value='{{enddate}}' id="enddate" />
	    <button type="submit" class="btn btn-primary pull-right" id="update_report" name="update_report">Update Report</button>
	  </div>
	</div>
      </div>
    </div>
  </div>
</div>
</form>

<div>

  <div class="span7">
    <h2><span>{{ loc_count }} Active Locations since {{ startdate }}</span></h2>
    <div class="map">
      <div id="map"></div>
    </div>
    <div id="map-help">
      <h4>Click on a location marker for detailed information on location activity.</h4>
    </div>
  </div>

  <div class="span5">
    <h2>Summary Statistics</h2>
  
    <div class="module">
      <h3>Results160</h3>
      <div class="toolbar">
	<a href="/results160" class="pull-right">All Results160 Stats</a>
      </div>
      <ul class="stats">
	<li>
	  <div class="report"><span>{{ loc_count }}</span>Number of Active Sites.</div>
	</li>
	<li>
	  <div class="report"><span>{{ eid_processed }}</span>EID Samples Processed at Lab.</div>
	</li>
	<li>
	  <div class="report"><span>{{ res_count }}</span>Results Delivered to Clinics by SMS.</div>
	  <div class="caption"></div>
	</li>
      </ul>
    </div>

    <div class="module">
      <h3>RemindMI</h3>
      <div class="toolbar">
	<a href="/remindmi" class="pull-right">All RemindMI Stats</a>
      </div>
      <ul class="stats">
	<li>
          <div class="report"><span>{{ mothers_registered }}</span> Mothers Registered.</div>
	</li>
	<li>
          <div class="report"><span>{{ all_msgs }}</span> Messages Sent.</div>
	</li>
	<li>
          <div class="report"><span>{{ births_registered }}</span> Births Registered.</div>
	</li>
      </ul>
    </div>

    <div class="module">
      <h3>Anthrowatch</h3>
      <div class="toolbar">
	<a href="/growth" class="pull-right">All AnthroWatch Stats</a>
      </div>
      <ul class="stats">
	<li>
          <div class="report"><span>{{ ass_count }}</span> Number of Children Assessed.</div>
	</li>
	<li>
          <div class="report"><span>{{ ass_suspect }}</span> Number of Suspect Cases.</div>
	</li>
	<li>
          <div class="report"><span>{{ ass_severe }}</span> Severe (Underweight, Wasting, Stunting) Cases.</div>
	</li>
      </ul>
    </div>

  </div> <!-- end span5 -->

</div>

<div id="location_data" style="display: none;">
  <ul>{% for location in locations %}
    <li lat="{{ location.point.latitude }}" lng="{{ location.point.longitude }}" slug="{{ location.slug|upper }}" name="{{ location.name }}">
      {% render_location %}
    </li>
    {% endfor %}
  </ul>
</div>
</div>

<script type="text/javascript">
    $(function() {

        /* initialize the google map */
	var map = new google.maps.Map(
            $("#map").get(0), {
                mapTypeId: google.maps.MapTypeId.TERRAIN,
                center: new google.maps.LatLng(-13.966, 33.761),
                zoom: 1
            }
        );

        var bounds = new google.maps.LatLngBounds();
        
        $("#location_data ul li").each(function() {
            var loc = $(this);
            var lat = loc.attr("lat");
            var lng = loc.attr("lng");
            if(lat && lng) {
                
                var infowindow = new google.maps.InfoWindow({
                    "content": loc.html()
                });
                
                var point = new google.maps.LatLng(lat, lng);
                var marker = new google.maps.Marker({
                    "position": point,
                    "title": loc.attr("name") + " (" + loc.attr("slug") + ")",
                    "map": map
                }); 
                    
                google.maps.event.addListener(marker, 'click', function() {
                    infowindow.open(map,marker);
                });
                
                bounds.extend(point);
                
            }
        });

        map.fitBounds(bounds);
    });
  </script>  
</div> 
{% endblock %}
