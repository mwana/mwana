{# TODO: Find a better way of displaying the reports to avoid repeating code #}
{% extends "base.html" %}
{% load forms_tags %}
{% load labresults_tags %}
{% load render_table from django_tables2 %}
{% block title %}Results160 Reports - RapidSMS for Health{% endblock %}

{% block javascripts %}
{{ block.super }}
<script type="text/javascript" src="{{ STATIC_URL }}malawi/javascripts/moment.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}malawi/javascripts/daterangepicker.js"></script>
{% endblock %}

{% block stylesheets %}
{{ block.super }}
<link type="text/css" rel="stylesheet"
      href="{{ STATIC_URL }}stylesheets/modules.css" />
<link type="text/css" rel="stylesheet"
      href="{{ STATIC_URL }}locations/stylesheets/locations.css" />
<link type="text/css" rel="stylesheet"
      href="{{ STATIC_URL }}locations/stylesheets/label-overlay.css" />
<link type="text/css" rel="stylesheet"
      href="{{ STATIC_URL }}labresults/stylesheets/labresults.css" />
<link rel="stylesheet" href="{{ STATIC_URL }}malawi/stylesheets/daterangepicker-bs2.css" type="text/css" media="screen" />
{% endblock %}

{% block content %}
{# TODO: Find a better way of displaying the reports to avoid repeating code #}

<div class="span12">

<div class="page-header">
  <h1>Results160 Reports</h1>
</div>

<!-- <h3>Report Options</h3> -->
<form method="GET" id="remindmi_options" action="">
<div class="well flush row-fluid">
  <div class="span12">
    <!-- Legend ? -->
    <div class="row-fluid">
      <div class="span4">
	<!-- r1c1 -->
	<select name="location" id="location" value="{{location}}">
          <option value="All Districts"
                  {% ifequal selected_location "All Districts" %}
                  selected="selected"
                  {% endifequal %}>All Districts</option>
          {% for location in districts %}
          <option value="{{ location }}"
		  {% ifequal selected_location location %}
		  selected="selected"
		  {% endifequal %}>{{ location }}</option>
	  {% endfor %}
        </select>
	<div class="row-fluid">
	  <div class="span12">
	    <br />
	    <!-- r2c1 -->
	  </div>
	</div>
      </div>
      <div class="span4">
	<!-- r1c2 -->
	<div class="row-fluid">
	  <div class="span12">
	    <br />
	    <!-- r2c2 -->
	  </div>
	</div>
      </div>
      <div class="span4">
	<!-- r1c3 -->
	<div id="reportrange" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc">
	  <i class="glyphicon glyphicon-calendar icon-calendar icon-large"></i>
	  <span></span> <b class="caret"></b>
	</div>
	<script type="text/javascript" src="{{ STATIC_URL }}malawi/javascripts/reportrange.js"></script>
	<div class="row-fluid">
	  <div class="span12">
	    <br />
	    <!-- r2c3 -->
	    <input type="hidden" name="startdate" value='{{startdate}}' id="startdate" />
	    <input type="hidden" name="enddate" value='{{enddate}}' id="enddate" />
	    <button type="submit" class="btn btn-primary pull-right" id="update_report" name="update_report">Update Report</button>
	  </div>
	</div>
      </div>
    </div>
  </div>
</div>
</form>

<div>
  <div class="left">
    <div class="module">
       <h2>Results160 Reports in period {{startdate}} to {{enddate}}</h2>
      <br>
      <p>Generated on <b>{{formattedtoday}}</b> at <b>{{formattedtime}}</b>
	by <b>{{ user.username|title }}</b></p>

      <div>

	<div class="module">
          <h2>Percentage (%) Positivity of selected sample data</h2>
          <table width="100%" class="th" bgcolor="#EEEEEE">
            <tr class="th" >
              <td align="center" width="295">
                <p align="center"><font size="6">
		    {{percent_positive_district }}%
		</font></p>
                <p align="center"><font size="3" ><b>Positivity</b></font></p>
              </td>
              <td width="407" colspan="2">
                Average Positivity for {{total_dbs}} samples processed from
		{{startdate}} to {{enddate}}
                <p>{{percent_negative_district}}% Negative,</p>
                <p>{{percent_rejected_district}}% Rejected</p>
              </td>
            </tr>
          </table>
        </div>
        <p align="center"><h3>Results160 Report 1 - Results
            Tested By Lab and Received By Facilities between
	    StartDate: {{startdate}} Enddate: {{enddate}} |
<a href="{% url 'csv_report_one' %}?location={{selected_location}}&start_date={{startdate|date:'Y-m-d'}}&end_date={{enddate|date:'Y-m-d'}}">Export CSV</a></h3>
	<p><b>DEFINITION  - Tested - means processed by lab
	    and result recorded,  Verified â€“ means lab have
	    approved its release,  Received - means facilities
	    have successfully received the results via
	    SMS</b></p>
	<p></p>
  {% render_table tested_retrieved_table %}
	<br>
          <h3>Results160 Report 2 - Pending Results for Clinics between
	    StartDate: {{startdate}} Enddate: {{enddate}}
	  </h3>
	<p></p>
	<p><b>DEFINITION  -  Shows the number of samples recorded as received
	    at laboratory,  but not yet received by facility via SMS. New -
	    A fresh result from the lab, Notified - Clinic has been notified of
	    new result, Updated - record has been updated from the lab,
	    Unprocessed - At lab, not processed yet.</b></p>
	<br>
  {% render_table pending_results_table %}
	<br>
        <h3>Results160 Report 3 - Trends of Result Retrieval in period between
	  StartDate: {{startdate}} Enddate: {{enddate}}</h3>
	<br>
	<p><b>DEFINITION  -  Shows the frequency of result retrieval over the
	    selected period</b></p>
	<p>
          Showing a total of {{ tt_in_graph }} results received in the
          period {{startdate|date:"j M Y"}} to {{enddate|date:"j M Y"}}
        </p>

        {% for record in graph %}

        {% for column in record %}
        {% if not forloop.counter0 %}
        {{column}}&nbsp;
        {% else %}
        {% if column %}
        <img src="{{ STATIC_URL }}labresults/images/green-bar.GIF"
	     alt="missing bar" height="10"
             width="{% widthratio column single_bar_length 100 %}" />
	{{column}}

        {% else %}
        Nil
        {% endif %}
        <br>
        {% endif %}
        {% endfor %}
        {% endfor %}
      </div>
        <div class="module">
          <h2>RemindMi Reports in period {{startdate}} to {{enddate}}</h2>
          <p>
            <h3>RemindMe Report 1 - Births from Clinics between StartDate:
	      {{startdate}} and Enddate: {{enddate}}
	    </h3>
	    <br>
	  <p><b>DEFINITION - Showing the number of births registered by
	      facility in the given period (in all districts).</b></p>
          <table width="100%">
            {% for record in births_rpt %}
            <tr>
              <td width="20">
                {% if forloop.counter0 %}
                {% if not forloop.last %}
                {{ forloop.counter0 }}
                {% endif %}
                {% endif %}
              </td>
              {% for column in record %}
              {% if column %}
              {% if not forloop.parentloop.counter0 %}
              <td width="20"><u>{{ column }}</u></td>
              {% else %}
              {% if forloop.parentloop.last %}
              <td width="20"><b>{{ column }}</b></td>
              {% else %}
              <td width="20">{{ column }}</td>
              {% endif %}
              {% endif %}
              {% else %}
              {% if forloop.parentloop.last %}
              <td><b> 0 </b></td>
              {% else %}
              <td> 0 </td>
              {% endif %}
              {% endif %}
              {% endfor %}
            </tr>
            {% endfor %}
          </table>
        </div>
    </div>
  </div>
  <div class="clear-hack"></div>
</div>

</div>
</div>
{% endblock %}
