{# TODO: Find a better way of displaying the reports to avoid repeating code #}
{% extends "layout.html" %}
{% load forms_tags %}

{% block title %}Mwana VL Reports - {{ block.super }}{% endblock %}

{% block stylesheets %}
{{ block.super }}
<style type="text/css">
    #wrapper {
        background: none repeat scroll 0 0 #FFFFFF;
        box-shadow: 4px 4px 8px #AAAAAA;
        margin: 0.5em auto 0;
        width: 95%;
    }
    /*    .ui-dialog { z-index: 21000 !important ;}*/
    .ui-widget {
        font: 9pt "Lucida Grande", "Bitstream Vera Sans", Verdana, sans-serif !important;
        font-size: 1.1em !important;
    }
</style>
<link type="text/css" rel="stylesheet" href="{{ MEDIA_URL }}stylesheets/modules.css" />
<link type="text/css" rel="stylesheet" href="{{ MEDIA_URL }}locations/stylesheets/locations.css" />
<link type="text/css" rel="stylesheet" href="{{ MEDIA_URL }}locations/stylesheets/label-overlay.css" />
<link type="text/css" rel="stylesheet" href="{{ MEDIA_URL }}labresults/stylesheets/labresults.css" />
<link type="text/css" rel="stylesheet" href="{{ MEDIA_URL }}reports/stylesheets/chosen.css" />
<link type="text/css" rel="stylesheet" href="{{ MEDIA_URL }}reports/stylesheets/jquery-ui-1.10.2.redmond.min.css" />

{% endblock %}

{% block javascripts %}
<script type="text/javascript" src="{{ MEDIA_URL }}reports/javascripts/jquery-1.8.0.min.js" ></script>
<script type="text/javascript" src="{{ MEDIA_URL }}reports/javascripts/chosen.jquery.min.js" ></script>
<script type="text/javascript" src="{{ MEDIA_URL }}reports/javascripts/location_selector.js" ></script>
<script type="text/javascript" src="{{ MEDIA_URL }}reports/javascripts/jquery-ui-1.8.23.custom.min.js" ></script>
<script>
    $(function(){
        $(".datefield").datepicker({ dateFormat: 'yy-mm-dd' })
        $.datepicker.formatDate
    });
</script>

{% endblock %}

{% block content %}

{%if userHasNoAssingedFacilities%}
<h2>Issue</h2>
You currently don't belong to any group for viewing reports. Contact the system administrator at <a href="mailto:{{adminEmail}}">{{adminEmail}}</a> for help.
{%else%}


    <div class="left">
        <div class="module">
         
            <h2 id="Results160">VL Reports</h2>
            <br>
            <form name="getValues" action="" method="GET">

                <table border="1" width="100%" id="input_parameters_table">
                    <thead>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Province</th>
                    <th>District</th>
                    <th>Facility</th>
                    <th>Implementer</th>
                    <th></th>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" id="startdate" name="startdate" class="datefield" size="9" value='{{ fstartdate }}' placeholder='{{ fstartdate }}' /></td>
                            <td><input type="text" id="enddate" name="enddate" class="datefield" size="9" value='{{ fenddate }}'  placeholder='{{ fenddate }}' /></td>
                            <td>{% autoescape off %}
                                {{rpt_provinces}}
                                {% endautoescape %}
                            </td>
                            <td>{% autoescape off %}
                                {{rpt_districts}}
                                {% endautoescape %}
                            </td>
                            <td>{% autoescape off %}
                                {{rpt_facilities}}
                                {% endautoescape %}
                            </td>
                            <td>{% if is_report_admin %}
                                {% autoescape off %}
                                {{rpt_group}}
                                {% endautoescape %}
                                {%endif%}</td>
                            <td><input type="submit" value="Ok" name="SubmitValues" /></td>
                        </tr>
                    </tbody>
                </table>

            </form><p><hr>

            Generated on <b>{{formattedtoday}}</b> at <b>{{formattedtime}}</b> by <b>{{ user.username|title }}</b>
            <p>

            <h3 id="tested_and_sent">Processed and Sent Samples&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                StartDate: {{startdate}} Enddate: {{enddate}}</h3>
            <p>
                Showing number of VL samples processed in reporting period and also how many of these
                were retrieved by facilities within the same reporting period
            <p>
            <table width="100%">
                {% for record in processed_vs_tested_rpt %}
                <tr>
                    <td width="20">
                        {% if forloop.counter0 %}
                        {% if not forloop.last %}
                        {{ forloop.counter0 }}
                        {% endif %}
                        {% endif %}
                    </td>
                    {% for column in record %}
                    {% if column %}
                    {% if not forloop.parentloop.counter0 %}
                    <td width="20"><u>{{ column }}</u></td>
                    {% else %}
                    {% if forloop.parentloop.last %}
                    <td width="20"><b>{{ column }}</b></td>
                    {% else %}
                    {%ifequal column min_processing_time%}
                    {%if forloop.last %}
                    <td width="20" bgcolor="#66CC00">{{ column }}</td>
                    {%else%}
                    <td width="20">{{ column }}</td>
                    {%endif%}
                    {% else %}
                    {%ifequal column max_processing_time%}
                    {%if forloop.last %}
                    <td width="20" bgcolor="#FFFF33">{{ column }}</td>
                    {%else%}
                    <td width="20">{{ column }}</td>
                    {%endif%}
                    {% else %}
                    <td width="20">{{ column }}</td>
                    {% endifequal %}
                    {% endifequal %}
                    {% endif %}
                    {% endif %}
                    {% else %}
                    {% if forloop.parentloop.last %}
                    <td><b> 0 </b></td>
                    {% else %}
                    <td> 0 </td>
                    {% endif %}
                    {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </table>
            <p>

        
        <div class="clear-hack"></div>
    </div>

    {% csrf_token %}
</div>

<script type="text/javascript">
    $("#rpt_group").chosen();
    $("table").attr("onclick", "showExportPopup(this)")
    $("table").attr("title", "Click here to export to Excel")
    $("#input_parameters_table").attr("onclick", "")
    $("#input_parameters_table").attr("title", "Choose Parameters")
</script>
<script type="text/javascript">
    function _showExportReportIntro(showDialog) {
        if(showDialog !== true){
            return;
        }
        var htmlCode = "<html><p>Hello {{ user_name }},<br>You can now now export reports to Excel/CSV. To begin exporting a report just click on it!</html>";
        $(htmlCode).dialog({
            draggable: false,
            resizable: true,
            width: 400,
            modal: true,
            hide: 'slide',
            title: 'Message',
            buttons: {
                "Don't show this again": function() {
                    $.post( "/reports/save_user_preferences/", { pref_id: "{{ pref_id }}",
                        val: "{{ val }}", csrfmiddlewaretoken: "{{ csrf_token }}",
                        csrf_token: "{{ csrf_token }}" } ).done(function( data ) {
                        
                    });
                    $(this).dialog("close");
                },
                Dismiss: function() {
                    $(this).dialog("close");
                }
            }
        });
    };
    window.onload = _showExportReportIntro({{ show_export_msg }});

    function showExportPopup(elem){
        var d = new Date();
        var html_code = "";
        var filename = 'mwana_export_' + d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate() + "_" + d.getHours() + d.getMinutes() + '_' + d.getSeconds() + '.csv';
        html_code = html_code + '<form name="postValues" action="/surveillance/export_to_csv/?filename=' + filename + '&my_table=" method="POST">';
        html_code = html_code + "{% csrf_token %}"
        html_code = html_code + '<input id="export-to-csv-btn" class="button" type="submit" value="Export to csv" name="export-to-csv-btn" />';
        html_code = html_code + '<input type="hidden" name="csv_text" id="csv_text" value="'+ elem.innerHTML.replace(/\n/g, '').replace(/"/g, "'") +'">';
        html_code = html_code + "<p>";
        html_code = html_code + '</form>';

        $(html_code).dialog({
            draggable: false,
            resizable: true,
            width: 400,
            modal: true,
            hide: 'slide',
            title: 'Export Report',
            buttons: {
                Close: function() {
                    $(this).dialog("close");
                }
            }
        });
    }
</script>
{%endif%}
{% endblock %}
