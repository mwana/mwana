# vim: ai ts=4 sts=4 et sw=4
"""
Updates Reporting table ScaleUpSite
"""
from mwana.apps.labresults.models import Result
from mwana.apps.reports.models import ScaleUpSite
from mwana.const import CLINIC_SLUGS
from mwana.apps.locations.models import Location
from datetime import date
from datetime import timedelta
from django.contrib.auth.models import Group
from django.contrib.auth.models import User
from django.core.management.base import LabelCommand


class Command(LabelCommand):
    help = "Updates Reporting table ScaleUpSite"

    def handle(self, *args, **options):
        update_locations()
        

def __del__(self):
    pass


def heal_locations():
    for loc in Location.objects.filter(type__slug__in=list(CLINIC_SLUGS), parent=None):
        district_slug = loc.slug[:4] + '00'
        districts = Location.objects.filter(slug=district_slug)
        if districts:
            loc.parent = districts[0]
            loc.save()


def update_art():
    codes = ['101010', '101012', '101014', '101016', '101021', '101028', '101032', '102016', '102021', '102022', '102023', '102028', '102041', '103011', '103014', '103016', '103019', '103020', '104001', '104010', '104014', '104016', '104017', '104019', '104020', '104021', '104022', '104025', '104030', '105001', '105002', '105011', '105013', '105014', '105020', '106010', '106014', '106015', '106021', '106022', '106023', '106024', '106025', '201010', '201015', '202001', '202010', '202012', '202013', '202016', '202017', '202019', '202022', '202023', '203012', '204010', '204012', '204013', '204015', '204016', '204018', '204021', '204023', '204024', '204025', '204026', '204027', '204030', '204034', '204036', '204042', '205001', '205003', '206016', '206020', '207012', '207015', '207020', '207021', '207022', '207024', '207027', '208001', '208010', '208013', '208014', '209017', '209032', '210001', '210012', '210021', '210023', '210024', '210027', '210030', '210032', '210045', '301013', '301014', '301015', '301017', '303013', '303016', '303019', '303036', '303041', '304010', '304011', '304014', '304015', '304016', '304018', '304020', '304021', '304024', '304026', '304028', '305010', '305011', '305012', '305016', '305028', '305032', '306010', '306011', '306012', '306013', '307001', '307011', '308002', '308011', '401011', '401014', '402001', '402018', '403001', '403011', '403012', '403013', '403036', '404010', '404013', '404014', '404015', '405019', '405021', '405026', '405027', '405029', '405030', '406010', '406011', '406013', '406014', '406015', '406016', '406017', '406018', '406019', '407001', '407018', '407028', '501011', '501013', '501015', '501016', '501018', '502001', '502010', '502011', '502012', '502015', '502016', '502017', '502018', '502024', '502035', '503011', '503012', '503014', '503015', '503091', '504010', '504012', '504013', '504014', '504015', '504017', '504018', '504019', '504020', '504021', '504024', '504028', '504032', '504034', '505010', '505016', '506011', '506015', '507011', '507012', '508012', '508014', '508015', '508016', '508017', '602001', '602012', '602018', '602019', '603012', '603015', '604017', '605001', '605009', '605011', '605014', '605016', '605017', '605019', '605020', '605027', '605036', '607017', '607019', '607020', '607025', '608002', '609001', '612011', '612012', '612013', '612014', '612015', '612017', '612018', '612019', '612020', '612021', '612022', '612023', '612024', '613010', '613017', '701010', '702001', '702002', '702020', '703001', '705001', '705002', '705012', '706001', '706024', '706032', '706033', '706034', '706038', '706040', '706050', '706091', '707002', '801001', '801010', '801024', '801026', '801028', '801030', '801031', '802001', '802010', '804001', '804002', '804013', '804028', '805010', '805011', '805013', '805014', '805018', '805022', '805025', '805026', '805029', '806001', '806010', '806011', '806012', '807001', '807002', '807014', '807022', '807025', '807026', '807033', '808001', '808010', '808011', '808014', '808025', '808026', '808030', '809011', '809016', '811012', '811013', '812001', '812015', '901002', '901012', '901016', '901019', '901020', '902001', '902002', '902003', '902012', '902016', '902019', '902025', '903015', '904017', '904023', '904024', '904027', '904035', '905001', '905010', '905014', '905017', '905020', '905026', '905031', '906002', '906012', '906017', '907019', '907021', '907025', '907030']
    for site in ScaleUpSite.objects.exclude(ART=True).filter(site__slug__in=codes):
        site.ART = True
        site.save()


def update_permissions():
    group, _ = Group.objects.get_or_create(name='Report Viewer')
    for user in User.objects.filter(is_active=True).exclude(groups__name='Lab Result Sender'):
        group.user_set.add(user)


def update_locations():
    heal_locations()
    update_art()
    update_permissions()
    for loc in Location.objects.filter(type__slug__in=list(CLINIC_SLUGS)):
        scaleup_site, created = ScaleUpSite.objects.get_or_create(site=loc)
        months_ago = date.today() - timedelta(days=93)
        # @type scaleup_site ScaleUpSite
        scaleup_site.ActiveOnMwana = Result.objects.filter(clinic=scaleup_site,
                                                           entered_on__gte=months_ago).exists() | Result.objects.filter(
            clinic=scaleup_site, collected_on__gte=months_ago).exists()
        scaleup_site.save()



