
{% extends "layout.html" %}
{% load forms_tags %}

{% block title %}Stock{{ block.super }}{% endblock %}

{% block stylesheets %}
{{ block.super }}

<style type="text/css">
    table{
        border: 0px;
    }
    td, th{
        border: 0px;
    }
    #wrapper {
        background: none repeat scroll 0 0 #FFFFFF;
        box-shadow: 4px 4px 8px #AAAAAA;
        margin: 0.5em auto 0;
        width: 90%;
    }
    .table-wrapper {
        position:relative;
    }
    .table-scroll {
        height:200px;
        overflow:auto;
        margin-top:20px;
    }
    .button {
        padding: 4px 12px;
        border-radius: 4px;
    }
</style>
<link type="text/css" rel="stylesheet" href="{{ MEDIA_URL }}reports/stylesheets/tabs.css" />
<link type="text/css" rel="stylesheet" href="{{ MEDIA_URL }}reports/stylesheets/jquery-ui-1.10.2.redmond.min.css" />
<link type="text/css" rel="stylesheet" href="{{ MEDIA_URL }}reports/stylesheets/chosen.css" />
{% endblock %}



{% block content %}

<form name="getValues" action="" method="POST" onsubmit="return confirmSetNewThreshold();">{% csrf_token %}

    <table border="0" width="100%" >
        <!--                        <tr>
                                    <td  >what goes here</td>
                                    <td></td>
                                </tr>-->
        <tr>
            <td id="graph">
                <div class="module">
                    <h3>Avialable Stock Today <extra id="info">- Selected a District from the Locations drop-down on the far right</extra></h3>
                    <div id="available_container" style="min-width: 400px; height: 400px; margin: 0 auto" class="module">Select the location/District you want to view data own.
                        The selection widget is at the far right. The following districts have data to view: {{districts_with_data}}
                    </div>
                    <hr>
                    <h3>Supplied Stock</h3>

                    <div id="supplied_container" style="min-width: 400px; height: 400px; margin: 0 auto" class="module">Select the location/District you want to view data own.

                    </div>
                    <hr>
                    <h3>Dispensed Stock</h3>

                    <div id="dispensed_container" style="min-width: 400px; height: 400px; margin: 0 auto" class="module">Select the location/District you want to view data own.

                    </div>
                </div>
            </td>
            <td style="text-align: left; float: right" >
                Show Pies <input type="checkbox" id="showPieCharts" name="showPieCharts" value="ON" onchange="reloadGraphs()" />
                <input type="text" id="startdate" name="startdate"  class="datefield" size="9" value='{{ fstart_date }}' placeholder='{{ fstart_date }}' />
                to <input type="text" id="enddate" name="enddate"  class="datefield" size="9" value='{{ fend_date }}'  placeholder='{{ fend_date }}' />
                <input class="button" type="submit" value="Ok" name="SubmitValues" onclick="document.getElementById('update_user_incidents').value = '';" />
                <hr>
                <div id="locations_title">
                    <div class="module" style="padding-bottom: 0.5em" ><h3>Locations</h3></div>
                    {% autoescape off %}
                    {{ rpt_districts }}
                    {% endautoescape %}
                    <div class="table-wrapper">
                        <div class="table-scroll">
                            <table id="facilitygrid"></table>
                        </div>
                    </div>
                    <hr>
                    <div class="module"><h3>Stock Items</h3></div>
                    <div class="table-wrapper">
                        <div class="table-scroll">
                            <table>
                                <tr>
                                    <td><input type='checkbox' onchange='toggleSelectedStock(this.checked)'> All Stock</td>
                                </tr>
                                {% autoescape off %}
                                {{ stock_selection_grid }}
                                {% endautoescape %}</table>
                        </div>
                    </div>
                    <hr>
                    {% ifequal 'true' can_set_threshold %}
                    <div class="module" id="thresholdDiv"><h3>Set New Threshold</h3>
                        <div>
                            <div id="new_threshhold">
                                <table border="0">

                                    <tbody>
                                        <tr>
                                            <td>Facility:</td>
                                            <td><input type="hidden" name="new_threshold_facility" value="" />
                                                <label id="new_threshold_facility_label"></label><br></td>
                                        </tr>
                                        <tr>
                                            <td>Stock:</td>
                                            <td><input type="hidden" name="new_threshold_stock" value="" />
                                                <label id="new_threshold_stock_label"></label><br></td>
                                        </tr>
                                        <tr>
                                            <td>Amount:</td>
                                            <td><select name="new_threshhold_value">
                                                    <option id='num_5' value='5'>5</option>
                                                    <option id='num_6' value='6'>6</option>
                                                    <option id='num_7' value='7'>7</option>
                                                    <option id='num_8' value='8'>8</option>
                                                    <option id='num_9' value='9'>9</option>
                                                    <option id='num_10' value='10'>10</option>
                                                    <option id='num_11' value='11'>11</option>
                                                    <option id='num_12' value='12'>12</option>
                                                    <option id='num_13' value='13'>13</option>
                                                    <option id='num_14' value='14'>14</option>
                                                    <option id='num_15' value='15'>15</option>
                                                    <option id='num_16' value='16'>16</option>
                                                    <option id='num_17' value='17'>17</option>
                                                    <option id='num_18' value='18'>18</option>
                                                    <option id='num_19' value='19'>19</option>
                                                    <option id='num_20' value='20'>20</option>
                                                    <option id='num_21' value='21'>21</option>
                                                    <option id='num_22' value='22'>22</option>
                                                    <option id='num_23' value='23'>23</option>
                                                    <option id='num_24' value='24'>24</option>
                                                    <option id='num_25' value='25'>25</option>
                                                    <option id='num_26' value='26'>26</option>
                                                    <option id='num_27' value='27'>27</option>
                                                    <option id='num_28' value='28'>28</option>
                                                    <option id='num_29' value='29'>29</option>
                                                    <option id='num_30' value='30'>30</option>
                                                    <option id='num_31' value='31'>31</option>
                                                    <option id='num_32' value='32'>32</option>
                                                    <option id='num_33' value='33'>33</option>
                                                    <option id='num_34' value='34'>34</option>
                                                    <option id='num_35' value='35'>35</option>
                                                    <option id='num_36' value='36'>36</option>
                                                    <option id='num_37' value='37'>37</option>
                                                    <option id='num_38' value='38'>38</option>
                                                    <option id='num_39' value='39'>39</option>
                                                    <option id='num_40' value='40'>40</option>
                                                    <option id='num_41' value='41'>41</option>
                                                    <option id='num_42' value='42'>42</option>
                                                    <option id='num_43' value='43'>43</option>
                                                    <option id='num_44' value='44'>44</option>
                                                    <option id='num_45' value='45'>45</option>
                                                    <option id='num_46' value='46'>46</option>
                                                    <option id='num_47' value='47'>47</option>
                                                    <option id='num_48' value='48'>48</option>
                                                    <option id='num_49' value='49'>49</option>
                                                    <option id='num_50' value='50'>50</option>
                                                    <option id='num_51' value='51'>51</option>
                                                    <option id='num_52' value='52'>52</option>
                                                    <option id='num_53' value='53'>53</option>
                                                    <option id='num_54' value='54'>54</option>
                                                    <option id='num_55' value='55'>55</option>
                                                    <option id='num_56' value='56'>56</option>
                                                    <option id='num_57' value='57'>57</option>
                                                    <option id='num_58' value='58'>58</option>
                                                    <option id='num_59' value='59'>59</option>
                                                    <option id='num_60' value='60'>60</option>
                                                    <option id='num_61' value='61'>61</option>
                                                    <option id='num_62' value='62'>62</option>
                                                    <option id='num_63' value='63'>63</option>
                                                    <option id='num_64' value='64'>64</option>
                                                    <option id='num_65' value='65'>65</option>
                                                    <option id='num_66' value='66'>66</option>
                                                    <option id='num_67' value='67'>67</option>
                                                    <option id='num_68' value='68'>68</option>
                                                    <option id='num_69' value='69'>69</option>
                                                    <option id='num_70' value='70'>70</option>
                                                    <option id='num_71' value='71'>71</option>
                                                    <option id='num_72' value='72'>72</option>
                                                    <option id='num_73' value='73'>73</option>
                                                    <option id='num_74' value='74'>74</option>
                                                    <option id='num_75' value='75'>75</option>
                                                    <option id='num_76' value='76'>76</option>
                                                    <option id='num_77' value='77'>77</option>
                                                    <option id='num_78' value='78'>78</option>
                                                    <option id='num_79' value='79'>79</option>
                                                    <option id='num_80' value='80'>80</option>
                                                    <option id='num_81' value='81'>81</option>
                                                    <option id='num_82' value='82'>82</option>
                                                    <option id='num_83' value='83'>83</option>
                                                    <option id='num_84' value='84'>84</option>
                                                    <option id='num_85' value='85'>85</option>
                                                    <option id='num_86' value='86'>86</option>
                                                    <option id='num_87' value='87'>87</option>
                                                    <option id='num_88' value='88'>88</option>
                                                    <option id='num_89' value='89'>89</option>
                                                    <option id='num_90' value='90'>90</option>
                                                    <option id='num_91' value='91'>91</option>
                                                    <option id='num_92' value='92'>92</option>
                                                    <option id='num_93' value='93'>93</option>
                                                    <option id='num_94' value='94'>94</option>
                                                    <option id='num_95' value='95'>95</option>
                                                    <option id='num_96' value='96'>96</option>
                                                    <option id='num_97' value='97'>97</option>
                                                    <option id='num_98' value='98'>98</option>
                                                    <option id='num_99' value='99'>99</option>
                                                    <option id='num_100' value='100'>100</option>
                                                </select></td>
                                        </tr>
                                        <tr>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                    </tbody>
                                </table>

                            </div>
                        </div>
                    </div>
                    {% endifequal %}
                </div>
            </td>

        </tr>
    </table>
</form>
<script type="text/javascript" src="{{ MEDIA_URL }}reports/javascripts/jquery-1.8.0.min.js" ></script>
<script type="text/javascript" src="{{ MEDIA_URL }}reports/javascripts/jquery-ui-1.8.23.custom.min.js" ></script>
<script type="text/javascript" src="{{ MEDIA_URL }}reports/javascripts/jquery.flippy.min.js" ></script>
<script type="text/javascript" src="{{ MEDIA_URL }}reports/javascripts/excanvas.min.js" ></script>
<script type="text/javascript" src="{{ MEDIA_URL }}reports/javascripts/chosen.jquery.min.js" ></script>
<script type="text/javascript"  src="{{ MEDIA_URL }}reports/javascripts/highcharts.js"></script>
<script type="text/javascript"  src="{{ MEDIA_URL }}reports/javascripts/modules/exporting.js"></script>


<script type="text/javascript">
    window.fstart_date = '{{fstart_date2}}';
    window.fend_date = '{{fend_date2}}';
    var _facilityData = [];
    {% for location in facilities %}
    _facilityData.push({
        province_slug: '{{location.parent.parent.slug}}',
        province_name: '{{location.parent.parent.name}}',
        district_slug: '{{location.parent.slug}}',
        district_name: '{{location.parent.name}}',
        facility_slug: '{{location.slug}}',
        facility_name: '{{location.name}}'
    });
    {% endfor %}


    window.facilityData = _facilityData;

    var _stockData = [];
    {% for stock in stocks %}
    _stockData.push({
        stockId: '{{stock.id}}',
        stockCode: '{{stock.code}}',
        stockName: '{{stock.name}}',
    });
    {% endfor %}

    window.stockData = _stockData;


    var _facilityAvailableStockData = [];
    {% for sa in stockAccounts %}
    _facilityAvailableStockData.push({
        stockId: '{{sa.stock.id}}',
        stockCode: '{{sa.stock.code}}',
        stockName: '{{sa.stock.name}}',
        locationSlug: '{{sa.location.slug}}',
        amount: {{sa.amount}},
        currentThreshold: {{sa.current_threshold}},
    });
    {% endfor %}

    window.facilityAvailableStockData = _facilityAvailableStockData;

    var _suppliedStock = [];
    {% for sa in supplied_stock %}
    _suppliedStock.push({
        stockId: '{{sa.stock_account.stock.id}}',
        stockCode: '{{sa.stock_account.stock.code}}',
        stockName: '{{sa.stock_account.stock.name}}',
        locationSlug: '{{sa.stock_account.location.slug}}',
        amount: {{sa.supplied_amount}},
        expected_supply_level: {{sa.expected_supply_level}}
    });
    {% endfor %}

    window.suppliedStock = _suppliedStock;

    var _dispensedStock = [];
    {% for sa in dispensed_stock %}
    _dispensedStock.push({
        stockId: '{{sa.stock_account.stock.id}}',
        stockCode: '{{sa.stock_account.stock.code}}',
        stockName: '{{sa.stock_account.stock.name}}',
        locationSlug: '{{sa.stock_account.location.slug}}',
        amount: {{sa.dispensed_amount}},
        expected_dispensed_level: {{sa.expected_dispensed_level}}
    });
    {% endfor %}

    window.dispensedStock = _dispensedStock;

    window.selectedFacilities = {% autoescape off %} {{ selected_facilities }}{% endautoescape %}
    window.onload = function(){
        firerpt_districtsChange();
        window.selectorWidth = $('#locations_title')[0].offsetWidth ;
        var graphWidth = $('#graph').width();
        window.selectorLeft = Math.round($('#locations_title').offset().left );
        window.graphWidth = graphWidth;
        $('#graph').prop('width', graphWidth);
    }
    can_set_threshold = {{ can_set_threshold }};
</script>


<script type="text/javascript">
    function firerpt_districtsChange(){
        var districtDropDown = document.getElementById('rpt_districts');
        var districtSlug = districtDropDown.options[districtDropDown.selectedIndex].value;
        updateFacilitySelectionGrid(districtSlug, []);
        reloadGraphs();
    }

    function toggleSelectedFacilities(toggle){
        $('[name="_select_facility"]').prop('checked', toggle);
        reloadGraphs();
    }
    function toggleSelectedStock(toggle){
        $('[name="_select_stock"]').prop('checked', toggle);
        reloadGraphs();
    }
    function updateFacilitySelectionGrid(districtSlug, selected_facilities){
        var width = 2;
        var column = 1;

//        var code = "<tr><td colspan='"+ width + "'><input type='checkbox' checked='checked' onchange='toggleSelectedFacilities(this.checked)'> All Facilities</td></tr>";
        var code = "<tr><td colspan='"+ width + "'><input type='checkbox' onchange='toggleSelectedFacilities(this.checked)'> All Facilities</td></tr>";
        for(var item in window.facilityData){
            var datum = window.facilityData[item]
            if(districtSlug === datum.district_slug){
                if (column === 1){
                    code += '<tr>';
                }
                var title = datum.facility_name + ' - '+ datum.facility_slug;
                if ((window.selectedFacilities.indexOf(datum.facility_slug ) > -1) ||
                    (window.selectedFacilities.length === 1 && window.selectedFacilities[0] === "-1")){
                    code = code + '<td><input type="checkbox" onchange="reloadGraphs()" name="_select_facility" value="'+datum.facility_slug+'" parent_id="'+datum.district_slug + '" title="' + title + '" checked="checked" /><label title="' + title + '">' + datum.facility_name + '</label></td>\n'
                }

                else{
                    code = code + '<td><input type="checkbox" onchange="reloadGraphs()" name="_select_facility" value="'+datum.facility_slug+'" parent_id="'+datum.district_slug + '" title="' + title + '"  /><label title="' + title + '">' + datum.facility_name + '</label></td>\n'
                }

                if (column % width === 0){
                    code += '</tr>';
                }
                column += 1

            }
        }
        document.getElementById("facilitygrid").innerHTML = code
        try{
            var flip_direction = 'BOTTOM';

            $("#facilitygrid").flippy({
                duration: "500",
                verso: code,
                direction: flip_direction
            });
        }
        catch(error){
            //do something
        }
    }

</script>
<script type="text/javascript" >
    $(function(){
        $(".datefield").datepicker({ dateFormat: 'yy-mm-dd' });
        $.datepicker.formatDate;
    });
</script>
<script type="text/javascript">
    $(".drop-down").chosen();
    $(".chzn-single").css('width','207px');
    $(".chzn-drop").css('width','205px');
    $(".chzn-search input").css('width','170px');
    $(".chzn-container").css('width','220px');


</script>

<script type="text/javascript">
    function getAvailableStockValues(locationSlug, stockId){
        for(var item in window.facilityAvailableStockData){
            var datum = window.facilityAvailableStockData[item]
            if(datum.locationSlug === locationSlug && datum.stockId === stockId){
                return datum.amount;
            }
        }

        return 0;
    }

    function getSuppliedStockValues(locationSlug, stockId){
        for(var item in window.suppliedStock){
            var datum = window.suppliedStock[item]
            if(datum.locationSlug === locationSlug && datum.stockId === stockId){
                return datum.amount;
            }
        }

        return 0;
    }

    function getDispensedStockValues(locationSlug, stockId){
        for(var item in window.dispensedStock){
            var datum = window.dispensedStock[item]
            if(datum.locationSlug === locationSlug && datum.stockId === stockId){
                return datum.amount;
            }
        }

        return 0;
    }

    //window.locs = []
    function getAvgAvailableStockValues(locationSlug, total){

        var sum = 0;
        for(var item in window.facilityAvailableStockData){
            var datum = window.facilityAvailableStockData[item]
            if(datum.locationSlug === locationSlug){
                sum += datum.amount;
                //window.locs.push(datum.locationSlug)
            }
        }

        if(total > 0){
            return Math.round(sum/total);
        }

        return 0;
    }

    function getAvgCurrentThreshold(locationSlug, stockIds){

        var sum = 0;
        var total = 0;
        for(var item in window.facilityAvailableStockData){
            var datum = window.facilityAvailableStockData[item]
            if(datum.locationSlug === locationSlug && stockIds.indexOf(datum.stockId) > -1){
                sum += datum.currentThreshold;
                total += 1
            }
        }

        if(total > 0){
            return Math.round(sum/total);
        }

        return 0;
    }

    function getAvgExpectedSupply(locationSlug, stockIds){

        var sum = 0;
        var total = 0;
        for(var item in window.suppliedStock){
            var datum = window.suppliedStock[item]
            if(datum.locationSlug === locationSlug && stockIds.indexOf(datum.stockId) > -1){
                sum += datum.expected_supply_level;
                total += 1
            }
        }

        if(total > 0){
            return Math.round(sum/total);
        }

        return 0;
    }
    
    function getAvgExpectedDispensed(locationSlug, stockIds){

        var sum = 0;
        var total = 0;
        for(var item in window.dispensedStock){
            var datum = window.dispensedStock[item]
            if(datum.locationSlug === locationSlug && stockIds.indexOf(datum.stockId) > -1){
                sum += datum.expected_dispensed_level;
                total += 1
            }
        }

        if(total > 0){
            return Math.round(sum/total);
        }

        return 0;
    }
    function reloadGraphs(){
        reloadAvailableStock();
        reloadSuppliedStock();
        reloadDispensedStock();
    }

    function getSelectedIds(locationIds) {
        $("[name='_select_facility']").each(
        function () {
            if (this.checked) {
                locationIds.push(this.value)
            }
        });
    }
    function getSelectedNames(locationIds, facilityNames) {
        for (var item in window.facilityData) {
            var datum = window.facilityData[item]
            if (locationIds.indexOf(datum.facility_slug) > -1) {
                facilityNames.push(datum.facility_name)
            }
        }
    }
    function getSelectedStockIds(stockIds) {
        $("[name='_select_stock']").each(
        function () {
            if (this.checked) {
                stockIds.push(this.value)
            }
        });
    }
    function getselectedStocknames(stockIds, stockNames) {
        for (var item in window.stockData) {
            var datum = window.stockData[item]
            if (stockIds.indexOf(datum.stockId) > -1) {
                stockNames.push([datum.stockId, datum.stockName])
            }
        }
    }
    function setSelectedValues(locationIds, facilityNames, stockIds, stockNames) {
        getSelectedIds(locationIds);
        getSelectedNames(locationIds, facilityNames);
        getSelectedStockIds(stockIds);
        getselectedStocknames(stockIds, stockNames);
    }
    function fillPieData(seriesData, pieSeriesTitle, pieData) {
        seriesData.push({
            type: 'pie',
            name: pieSeriesTitle,
            data: $('#showPieCharts')[0].checked? pieData: null,
            center: [100, 80],
            size: 100,
            showInLegend: true,
            dataLabels: {
                enabled: false
            }
        });
    }
    function fillAverageTrend(seriesData, averageTrend, averageData) {
        seriesData.push({

            type: 'spline',
            name: averageTrend,
            data: averageData,
            marker: {
                lineWidth: 2,
                lineColor: Highcharts.getOptions().colors[3],
                fillColor: 'white'
            }
        });
    }
    function drawChart(chart, renderTo, mainChartTitle, facilityNames, pieChartTitle, seriesData) {
        $(document).ready(function () {
            chart = new Highcharts.Chart({
                chart: {
                    renderTo: renderTo
                },
                title: {
                    text: mainChartTitle
                },
                xAxis: {
                    categories: facilityNames
                },
                tooltip: {
                    formatter: function () {
                        var s;
                        if (this.point.name) { // the pie chart
                            s = '' +
                                this.point.name + ': ' + this.y + ' stock units';
                        } else {
                            s = '' +
                                this.series.name + ': ' + this.y;
                        }
                        return s;
                    }
                },
                labels: {
                    items: [
                        {
                            html: pieChartTitle,
                            style: {
                                left: '40px',
                                top: '8px',
                                color: 'black'
                            }
                        }
                    ]
                },
                series: seriesData


            });
        });
    }

    function confirmSetNewThreshold(){
   
        if($('[name="new_threshold_facility"]')[0].value === ''){
            return true;
        }
        if($('[name="new_threshold_stock"]')[0].value === ''){
            return true;
        }
        var elem = $('[name="new_threshhold_value"]')[0];
        if(elem.selectedIndex === -1){
            return true;
        }
        
        var selected_ids = []
        getSelectedStockIds(selected_ids)
        var oldValue =    getAvgCurrentThreshold($('[name="new_threshold_facility"]')[0].value, selected_ids);
        var newValue  = parseInt(elem.options[elem.selectedIndex].value);

        if(oldValue === newValue){
            return true
        }
        return confirm("You changed current threshold for stock '" + 
            (document.getElementById('new_threshold_stock_label').innerText ||
            document.getElementById('new_threshold_stock_label').textContent ||
            document.getElementById('new_threshold_stock_label').innerHTML.replace(/<.*?>/,"")
    ) +
            "' from " +oldValue + " to " + newValue + ". Do you want to continue?")
    }
    function reloadAvailableStock () {
        var chart;
        var locationIds = [];
        var facilityNames = []
        var stockIds = []
        var stockNames = []

        setSelectedValues(locationIds, facilityNames, stockIds, stockNames);

        districtDropDown = document.getElementById('rpt_districts');
        var districtSlug = districtDropDown.options[districtDropDown.selectedIndex].value;

        if(districtSlug.indexOf('--') > -1){
            $('extra')[0].textContent = "- Selected a District from the Locations drop-down on the far right";
        }else if(stockIds.length === 0 && locationIds.length > 0){
            $('extra')[0].textContent = "- Selected drugs on the far right";
        }else{
            $('extra')[0].textContent = '- ' + districtDropDown.selectedOptions[0].text;
        }

        if(stockNames.length === 1 && facilityNames.length === 1 && can_set_threshold){
            document.getElementById('new_threshold_facility_label').innerHTML = '<strong>' + facilityNames[0] + '</strong>';
            document.getElementById('new_threshold_stock_label').innerHTML = '<b>' + stockNames[0][1] + '</b>';
            document.getElementById('thresholdDiv').style.display = 'block';
            var elem = $('[name="new_threshhold_value"]')[0];
            var offset = parseInt(elem.options[0].value);
            elem.selectedIndex = getAvgCurrentThreshold(locationIds[0], stockIds) - offset;

            $('[name="new_threshold_facility"]')[0].value = locationIds[0];
            $('[name="new_threshold_stock"]')[0].value = stockNames[0][0];            
        }else if(can_set_threshold){
            document.getElementById('new_threshold_facility_label').innerHTML = '';
            document.getElementById('new_threshold_stock_label').innerHTML = '';
            document.getElementById('thresholdDiv').style.display = 'none';
            $('[name="new_threshold_facility"]')[0].value = '';
            $('[name="new_threshold_stock"]')[0].value = '';
        }
       

        var seriesData = [];
        var pieData = [];
        var averageData = [];
        for(var i in stockNames){
            var _name = stockNames[i];
            var stockPerLocation = []
            var stockTotal = 0;

            for(var loc in locationIds){
                var val = getAvailableStockValues(locationIds[loc], _name[0]);
                stockPerLocation.push(val);
                stockTotal += val;
            }
            seriesData.push({
                type: 'column',
                name: _name[1],
                data: stockPerLocation
            });
            pieData.push({
                name: _name[1],
                y: stockTotal
            });
        }

        for(var loc in locationIds){
            var val = getAvgCurrentThreshold(locationIds[loc], stockIds);
            averageData.push(val);
        }

        var averageTrend = 'Average Threshold';
        if(stockIds.length === 1){
            averageTrend = 'Threshold';
        }
        fillAverageTrend(seriesData, averageTrend, averageData);

        var pieSeriesTitle = 'Total consumption';
        var renderTo = 'available_container';
        var mainChartTitle = 'Available Stock Today';
        var pieChartTitle = 'Total stock available';
        fillPieData(seriesData, pieSeriesTitle, pieData);

        drawChart(chart, renderTo, mainChartTitle, facilityNames, pieChartTitle, seriesData);

    };

    function reloadSuppliedStock () {
        var chart;
        var locationIds = [];
        var facilityNames = [];
        var stockIds = [];
        var stockNames = [];

        setSelectedValues(locationIds, facilityNames, stockIds, stockNames);
        var seriesData = [];
        var pieData = [];
        var averageData = [];
        for(var i in stockNames){
            var _name = stockNames[i];
            var stockPerLocation = [];
            var stockTotal = 0;

            for(var loc in locationIds){
                var val = getSuppliedStockValues(locationIds[loc], _name[0]);
                stockPerLocation.push(val);
                stockTotal += val;
            }
            seriesData.push({
                type: 'column',
                name: _name[1],
                data: stockPerLocation
            });
            pieData.push({
                name: _name[1],
                y: stockTotal
            });
        }

        for(var loc in locationIds){
            var val = getAvgExpectedSupply(locationIds[loc], stockIds);
            averageData.push(val);
        }

        var averageTrend = 'Average Expected Supply';
        if(stockIds.length === 1){
            averageTrend = 'Expected Supply';
        }
        fillAverageTrend(seriesData, averageTrend, averageData);

        var pieSeriesTitle = 'Total Supplied';
        var renderTo = 'supplied_container';
        var mainChartTitle = 'Supplied Stock (' + window.fstart_date + ' - ' + window.fend_date + ')';
        var pieChartTitle = 'Total supplied stock';
        fillPieData(seriesData, pieSeriesTitle, pieData);

        drawChart(chart, renderTo, mainChartTitle, facilityNames, pieChartTitle, seriesData);

    };
    
    function reloadDispensedStock () {
        var chart;
        var locationIds = [];
        var facilityNames = []
        var stockIds = []
        var stockNames = []

        setSelectedValues(locationIds, facilityNames, stockIds, stockNames);
        var seriesData = [];
        var pieData = [];
        var averageData = [];
        for(var i in stockNames){
            var _name = stockNames[i];
            var stockPerLocation = []
            var stockTotal = 0;

            for(var loc in locationIds){
                var val = getDispensedStockValues(locationIds[loc], _name[0]);
                stockPerLocation.push(val);
                stockTotal += val;
            }
            seriesData.push({
                type: 'column',
                name: _name[1],
                data: stockPerLocation
            });
            pieData.push({
                name: _name[1],
                y: stockTotal
            });
        }

        for(var loc in locationIds){
            var val = getAvgExpectedDispensed(locationIds[loc], stockIds);
            averageData.push(val);
        }

        var averageTrend = 'Average Expected Expense';
        if(stockIds.length === 1){
            averageTrend = 'Expected Expense';
        }
        fillAverageTrend(seriesData, averageTrend, averageData);

        var pieSeriesTitle = 'Total Dispensed';
        var renderTo = 'dispensed_container';
        var mainChartTitle = 'Dispensed Stock (' + window.fstart_date + ' - ' + window.fend_date + ')';
        var pieChartTitle = 'Total dispensed stock';
        fillPieData(seriesData, pieSeriesTitle, pieData);

        drawChart(chart, renderTo, mainChartTitle, facilityNames, pieChartTitle, seriesData);

    };
</script>
<script type="text/javascript">
    $(document).ready(function() {
        var width = $('#locations_title').width()
        // check where the shoppingcart-div is
        var offset = $('#locations_title').offset();

        $(window).scroll(function () {
            var scrollTop = $(window).scrollTop(); // check the visible top of the browser
            var el = $('#locations_title')[0];
            if (offset.top < scrollTop){
                //                el.style.cssText = 'position: fixed; top: 20px; width: ' + (window.selectorWidth) + 'px;';
                el.style.cssText = 'position: fixed; top: 20px; width: ' + (window.selectorWidth) + 'px; left:' + (window.selectorLeft) + 'px;';
            }
            else {
                el.style.cssText = '';
            }
        });
    });
</script>

{% endblock %}
